#!/bin/zsh

# Uncomment for performance profiling
# zmodload zsh/zprof

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ Basics                                                                     ║
# ╚════════════════════════════════════════════════════════════════════════════╝

export OS="$(uname | tr '[:upper:]' '[:lower:]')"

# Function to check if a program is available, optional: specify OS
function __is_available {
  prog="${1}"
  os="${2}"

  # Skip if OS requirement doesn't match current OS
  if [ "${os}" != "" ] && [ "${os}" != "${OS}" ]
  then 
    return 1
  fi

  # Check if program exists in PATH
  type "${prog}" > /dev/null 
  return "$?"
}

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ Exports                                                                    ║
# ╚════════════════════════════════════════════════════════════════════════════╝

export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ Ghostty                                                                    ║
# ╚════════════════════════════════════════════════════════════════════════════╝

# Ghostty terminal integration for enhanced shell features
if [ -n "${GHOSTTY_RESOURCES_DIR}" ]; then
  builtin source \
    "${GHOSTTY_RESOURCES_DIR}/shell-integration/zsh/ghostty-integration"
fi

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ General config                                                             ║
# ╚════════════════════════════════════════════════════════════════════════════╝

# History file location and size settings
export HISTFILE="${XDG_STATE_HOME}/zsh/history"
export HISTCONTROL="ignoredups:ignorespace"        # Ignore duplicates and commands starting with space
export HISTSIZE="100000"                           # Number of commands to keep in memory
export HISTFILESIZE="200000"                       # Number of commands to keep in history file
export SAVEHIST="${HISTSIZE}"                      # Number of commands to save to file

# Zsh history options for better history management
setopt HIST_IGNORE_ALL_DUPS     # Don't record duplicate commands
setopt HIST_IGNORE_SPACE        # Don't record commands starting with space
setopt EXTENDED_HISTORY         # Record timestamp and duration
setopt HIST_EXPIRE_DUPS_FIRST   # Expire duplicates first when trimming history
setopt HIST_IGNORE_DUPS         # Don't record immediately repeated commands
setopt HIST_VERIFY              # Show command before executing from history
setopt SHARE_HISTORY            # Share history across all sessions

# Terminal settings for proper color and character support
export TERM="xterm-256color"
export COLUMNS="80"

export TERMINFO="${XDG_DATA_HOME}/terminfo"
export TERMINFO_DIRS="${XDG_DATA_HOME}/terminfo:/usr/share/terminfo"

# Default editor (will be updated to nvim if available)
export EDITOR="vim"

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ Programs & tools                                                           ║
# ╚════════════════════════════════════════════════════════════════════════════╝

# Timezone list for tz tool (global timezone display)
# https://github.com/oz/tz/
export TZ_LIST="\
America/Los_Angeles;America/Chicago;\
America/New_York;Australia/Perth;"

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ ${PATH}                                                                    ║
# ╚════════════════════════════════════════════════════════════════════════════╝

# Docker (not docker-desktop)
export DOCKER_CONFIG="${XDG_CONFIG_HOME}/docker"

export NPM_CONFIG_INIT_MODULE="${XDG_CONFIG_HOME}/npm/config/npm-init.js"
export NPM_CONFIG_CACHE="${XDG_CACHE_HOME}/npm"

export _Z_DATA="$XDG_DATA_HOME/z"

export LESSHISTFILE="${XDG_STATE_HOME}/lesshst"
export MYSQL_HISTFILE="${XDG_DATA_HOME}/mysql_history"
export PSQL_HISTORY="${XDG_STATE_HOME}/psql_history"

# Performance optimizations
DISABLE_AUTO_UPDATE="true"
DISABLE_MAGIC_FUNCTION="true"
DISABLE_COMPFIX="true"
skip_global_compinit=1

# Oh-My-Zsh setup
export ZSH="${XDG_DATA_HOME}/.oh-my-zsh"

# Optimized completion loading - cache compinit for 24 hours
autoload -Uz compinit
for dump in "$XDG_CACHE_HOME"/zsh/zcompdump-$ZSH_VERSION(N.mh+24); do
  compinit -d "$XDG_CACHE_HOME/zsh/zcompdump-$ZSH_VERSION"
  break
done
compinit -C -d "$XDG_CACHE_HOME/zsh/zcompdump-$ZSH_VERSION"

# History configuration
CASE_SENSITIVE='false'
HYPHEN_INSENSITIVE='false'
HIST_STAMPS='yyyy-mm-dd'
HIST_IGNORE_SPACE='true'

source "$ZSH/oh-my-zsh.sh"


# === Shell configuration ===
# Load these BEFORE plugins so functions and completions are available
[ -f "${XDG_CONFIG_HOME}/zsh/exports.zsh" ] && source "${XDG_CONFIG_HOME}/zsh/exports.zsh"
[ -f "${XDG_CONFIG_HOME}/zsh/aliases.zsh" ] && source "${XDG_CONFIG_HOME}/zsh/aliases.zsh"
[ -f "${XDG_CONFIG_HOME}/zsh/functions.zsh" ] && source "${XDG_CONFIG_HOME}/zsh/functions.zsh"
[ -f "${XDG_CONFIG_HOME}/zsh/completions.zsh" ] && source "${XDG_CONFIG_HOME}/zsh/completions.zsh"

# === Plugin management ===
# Load after shell config so fzf-tab can use our settings and functions
source ~/.zgen/zgen.zsh

if ! zgen saved; then
  echo "Creating a zgen save..."

  zgen load Aloxaf/fzf-tab
  zgen load zsh-users/zsh-syntax-highlighting
  zgen load MichaelAquilina/zsh-you-should-use

  zgen save
fi

# === External tools ===
# Load external tools AFTER plugins
[ -f "${XDG_CONFIG_HOME}/zsh/external.zsh" ] && source "${XDG_CONFIG_HOME}/zsh/external.zsh"

# === Local overrides ===
if [[ -f "$HOME/.shell_env_local" ]]; then
  source "$HOME/.shell_env_local"
fi

# Generated for envman. Do not edit.
[ -s "$HOME/.config/envman/load.sh" ] && source "$HOME/.config/envman/load.sh"

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║ Stoicism                                                                   ║
# ╚════════════════════════════════════════════════════════════════════════════╝

fortune ~/.local/share/fortune
printf "\n"

__is_available starship \
&& eval "$(starship init zsh)"

__is_available mise \
&& eval "$(mise activate zsh)"

# zprof
